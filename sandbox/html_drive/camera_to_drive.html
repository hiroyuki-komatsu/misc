<html>
<head>
<style>
#camera {
  padding: 0;
  width: 480;
  height: 480;
}
#preview {
  position: absolute;
  top: 0;
  left: 0;
  width: 480;
  height: 480;
}
#overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 480;
  height: 480;
}
</style>
</head>
<body>
<div id="main">
  <div id="camera">
    <video id="preview" autoplay></video>
    <canvas id="overlay"></canvas>
  </div>
  <button id="capture">Capture</button><br/>
  <canvas id="snapshot" width=240 height=240></canvas>
</div>

<div id="auth">
  <button id="authButton">sign in</button>
</div>

<script src="gapi_config.js"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="initAuth()"></script>

<script>
function initPage() {
  let main = document.getElementById('main');
  let auth = document.getElementById('auth');
  main.style.display = 'none';
  auth.style.display = 'none';

  let preview = document.getElementById('preview');
  let overlay = document.getElementById("overlay");
  let capture = document.getElementById('capture');

  let camera = new Camera(preview);
  const constraints = {
    video: {width: 480, height: 480, facingMode: "environment"},
    audio: false
  };
  camera.initCamera(constraints).then(() => {
    initOverlay(overlay, camera.width, camera.height);
    capture.addEventListener('click', function() {
      cameraToDrive(camera);
    });
  });
  
  let authButton = document.getElementById('authButton');
  authButton.addEventListener('click', () => {
    GoogleClient.signIn();
  });
}

function initAuth() {
  const apiKey = GAPI_API_KEY;
  const clientId = GAPI_CLIENT_ID;
  const scope = 'https://www.googleapis.com/auth/drive';
  const discoveryDocs = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];

  GoogleClient.initAuth(apiKey, clientId, scope, discoveryDocs).then(() => {
    GoogleClient.setListener(updateSigninStatus);
  });
}

function updateSigninStatus(isSignedIn) {
  let main = document.getElementById('main');
  let auth = document.getElementById('auth');
  if(isSignedIn) {
    main.style.display = null;
    auth.style.display = 'none';
  } else {
    main.style.display = 'none';
    auth.style.display = null;
  }
}

function cameraToDrive(camera) {
  let canvas = document.getElementById('snapshot');
  camera.copyToCanvas(canvas);
  let filename = 'image.jpg';

  canvas.toBlob((blob) => {
    GoogleDrive.uploadFile(filename, blob);
  }, 'image/jpeg');
}

class Camera {
  constructor(preview) {
    this.preview = preview;
  }

  initCamera(constraints = undefined) {
    if (constraints == undefined) {
      constraints = {video: true, audio: false};
    }

    return new Promise(async (resolve, reject) => {
      let stream = await navigator.mediaDevices.getUserMedia(constraints);
      this.preview.srcObject = stream;
      this.preview.addEventListener('loadedmetadata', () => {
        resolve();
      });
    });
  }

  copyToCanvas(canvas) {
    let context = canvas.getContext('2d');
    context.drawImage(this.preview, 0, 0, canvas.offsetWidth, canvas.offsetHeight);
  }

  get width() {
    return this.preview.videoWidth;
  }

  get height() {
    return this.preview.videoHeight;
  }
}

function drawLine(context, x1, y1, x2, y2) {
  context.beginPath();
  context.moveTo(x1, y1);
  context.lineTo(x2, y2);
  context.stroke();
}

function initOverlay(overlay, width, height) {
  overlay.width = width;
  overlay.height = height;

  const dx = width / 5;
  const dy = height / 5;

  let context = overlay.getContext('2d');
  context.strokeStyle = '#666';
  context.lineWidth = 1;
  for (let i = 1; i <= 4; i++) {
    drawLine(context, dx * i, 0, dx * i, height);
    drawLine(context, 0, dy * i, width, dy * i);
  }
}

class GoogleClient {
  static initAuth(apiKey, clientId, scope, discoveryDocs) {
    return new Promise((resolve, reject) => {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: apiKey,
          clientId: clientId,
          scope: scope,
          discoveryDocs: discoveryDocs,
        }).then(() => {
          resolve();
        });
      });
    });
  }

  static setListener(callback) {
    gapi.auth2.getAuthInstance().isSignedIn.listen(callback);
    callback(gapi.auth2.getAuthInstance().isSignedIn.get());
  }

  static singIn() {
    gapi.auth2.getAuthInstance().signIn();
  }
}

function blobToBase64(blob) {
  let reader = new window.FileReader();
  reader.readAsDataURL(blob); 

  return new Promise((resolve, reject) => {
    reader.onloadend = function() {
      let base64data = reader.result;
      base64data = base64data.substr(base64data.indexOf(',') + 1);
      resolve(base64data);
    }
  });
}

class GoogleDrive {
  static async uploadFile(filename, blob) {
    let request = await GoogleDrive.createRequest(filename, blob);
    gapi.client.load('drive', 'v3').then(() => {
      gapi.client.request(request).then((response) => {
        console.log('saved:');
        console.log(response);
      });
    });
  }

  static async createRequest(filename, blob) {
    const boundary = Math.random().toString(36);
    const request = {
      'path': '/upload/drive/v3/files',
      'method': 'POST',
      'params': {
        'uploadType': 'multipart'
      },
      'headers': {
        'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
      },
      'body': await GoogleDrive.createMultipart(filename, blob, boundary)
    };
    return request;
  }

  static async createMultipart(filename, blob, boundary) {
    const delimiter = '--' + boundary;
    const contentType = blob.type;
    const metadata = {
      'name': filename,
      'mimeType': contentType
    };

    const base64Data = await blobToBase64(blob);
    const data = [
      '',
      delimiter,
      'Content-Type: application/json',
      '',
      JSON.stringify(metadata),
      '',
      delimiter,
      'Content-Type: ' + contentType,
      'Content-Transfer-Encoding: base64',
      '',
      base64Data,
      '',
      delimiter + '--',
    ];
    return data.join('\r\n');
  }
}

initPage();

</script>
</body>
</html>
