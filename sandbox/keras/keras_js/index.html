<html>
  <meta charset="utf-8">
  <script src="keras.js"></script>
<body>
<script>
function rgbaToRgb(image_rgba, width, height) {
  let image_rgb = [];
  for (let y = 0; y < height; ++y) {
    for (let x = 0; x < width; ++x) {
      const base = ((y * height) + x) * 4;  // 4 = size of rgba
      for (let i = 0; i < 3; ++i) {
        image_rgb.push(image_rgba.data[base + i]);
      }
    }
  }
  return image_rgb;
}

function imageToRgb(image) {
  let canvas = document.createElement('canvas');
  const size = 32;
  canvas.width = size;
  canvas.height = size;
  let context = canvas.getContext('2d');
  context.drawImage(image, 0, 0, image.width, image.height, 0, 0, size, size);

  const image_rgba = context.getImageData(0, 0, size, size);
  let image_rgb = rgbaToRgb(image_rgba, size, size);
  return image_rgb;
}

function imageToData(filename) {
  let base_image = new Image();
  base_image.src = filename;
  return new Promise((resolve, reject) => {
    base_image.onload = () => {
      resolve(imageToRgb(base_image));
    }
  });
}

class KerasModel {
  constructor() {
    this.model = new KerasJS.Model({
      filepaths: {
        model: 'model.json',
        weights: 'model_weights.buf',
        metadata: 'model_metadata.json'
      },
      gpu: true
    });
    this.ready();
  }

  async ready() {
    return this.model.ready();
  }

  async predict(input) {
    await this.ready();
    let result = await this.model.predict({'input': input});
    return result['output'];
  }
}

async function main() {
  let keras = new KerasModel();
  let image = new Float32Array(await imageToData('forest.jpg'));
  let result = await keras.predict(image);
  console.log(result);
}

main();
</script>
loaded.
</body>
</html>
