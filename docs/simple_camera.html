<html>
<body>
<video id="preview" autoplay playsinline></video>
<button id="capture">Capture</button>
<canvas id="snapshot"></canvas>

<script>
  function initCamera(preview, canvas) {
    const constraints = {
      video: {facingMode: "environment"},
      audio: false
    };
    navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
      preview.srcObject = stream;
      preview.addEventListener('loadedmetadata', () => {
        canvas.width = preview.videoWidth;
        canvas.height = preview.videoHeight;
      });
    });
  }

  async function captureCamera(preview, canvas, filename) {
    if (isIosSafari()) {
      let win = window.open('', '_blank');
      let blob = await canvasToBlob(canvas);
      let url = window.URL.createObjectURL(blob);
      win.location = url;
      return;
    }

    copyToCanvas(preview, canvas);
    let blob = await canvasToBlob(canvas);
    let url = window.URL.createObjectURL(blob);
    download(filename, url);
  }

  function copyToCanvas(preview, canvas) {
    let context = canvas.getContext('2d');
    context.drawImage(preview, 0, 0, canvas.offsetWidth, canvas.offsetHeight);
  }

  async function canvasToBlob(canvas) {
    return new Promise(function(resolve, reject) {
      canvas.toBlob((blob) => {
        resolve(blob);
      }, 'image/jpeg');
    });
  }

  function isIosSafari() {
    let ua = window.navigator.userAgent;
    let ios = !!ua.match(/iPad/i) || !!ua.match(/iPhone/i);
    let iosSafari = ios && !!ua.match(/WebKit/i) && !ua.match(/CriOS/i);
    return iosSafari;
  }

  function download(filename, url) {
    let link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
  }

  let preview = document.getElementById('preview');
  let snapshot = document.getElementById('snapshot');
  let capture = document.getElementById('capture');

  initCamera(preview, snapshot);
  capture.addEventListener('click', () => {
    captureCamera(preview, snapshot, 'image.jpg');
  });
</script>
</body>
</html>
